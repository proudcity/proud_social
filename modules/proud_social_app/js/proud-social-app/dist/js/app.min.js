!function($){var readMore=angular.module("readMore",[]);readMore.directive("readMore",function(){return{restrict:"A",transclude:!0,replace:!0,template:"<p></p>",scope:{moreText:"@",lessText:"@",words:"@",ellipsis:"@","char":"@",limit:"@",content:"@",moreCallback:"&",lessCallback:"&"},link:function(scope,elem,attr,ctrl,transclude){function splitIntoWords(div){function removeEmptyStrings(k){return""!==k}for(var rWordBoundary=/[\s\n\t]+/,output=[],i=0;i<div.childNodes.length;++i){var node=div.childNodes[i];if(node.nodeType===Node.TEXT_NODE){var words=node.nodeValue.split(rWordBoundary).filter(removeEmptyStrings);words.length&&output.push.apply(output,words)}else node.nodeType===Node.COMMENT_NODE||output.push(node.outerHTML)}return output}function readmore(text){var text=text,orig=text,regex=/\s+/gi,charCount=text.length,wordCount=text.trim().replace(regex," ").split(" ").length,countBy="char",count=charCount,foundWords=[],markup=text,more="";if(angular.isUndefined(attr.words)||(countBy="words",count=wordCount),"words"===countBy){var span=document.createElement("span");span.innerHTML=text,foundWords=splitIntoWords(span),foundWords.length>limit&&(text=foundWords.slice(0,limit).join(" ")+ellipsis,more=foundWords.slice(limit,count).join(" "),markup=text+moreText+'<span class="more-text">'+more+lessText+"</span>")}else count>limit&&(text=orig.slice(0,limit)+ellipsis,more=orig.slice(limit,count),markup=text+moreText+'<span class="more-text">'+more+lessText+"</span>");elem.append(markup),elem.find(".read-more").on("click",function(){$(this).hide(),elem.find(".ellipsis").hide(),elem.find(".more-text").addClass("show").slideDown(),scope.moreCallback&&scope.moreCallback()}),elem.find(".read-less").on("click",function(){elem.find(".read-more").show(),elem.find(".ellipsis").show(),elem.find(".more-text").hide().removeClass("show"),scope.lessCallback&&scope.lessCallback()})}var moreText=angular.isUndefined(scope.moreText)?' <a class="read-more">Read More...</a>':' <a class="read-more">'+scope.moreText+"</a>",lessText=angular.isUndefined(scope.lessText)?' <a class="read-less">Less ^</a>':' <a class="read-less">'+scope.lessText+"</a>",ellipsis=angular.isUndefined(scope.ellipsis)?"":'<span class="ellipsis">'+scope.ellipsis+"</span>",limit=angular.isUndefined(scope.limit)?150:scope.limit;attr.$observe("content",function(str){readmore(str)}),transclude(scope.$parent,function(clone,scope){readmore(clone.text().trim())})}}}),angular.module("socialAppParent",["socialApp","angular-lazycompile","angular-inview"]),angular.module("socialApp",["iso.directives","ngResource","ngSanitize","readMore"]).run(["$rootScope","$window",function($rootScope,$window){var drupal="undefined"!=typeof Drupal?Drupal:{};$rootScope.socialApi=_.get(drupal,"settings.social_wall.socialApi")||"http://45.55.8.62:8080/api/"}]).factory("SocialFeed",["$resource","$rootScope",function($resource,$rootScope){return{getUser:function(name,services,count){var url=$rootScope.socialApi+name+"/feed";return $resource(url,{format:"json",action:"query",callback:"JSON_CALLBACK"},{load:{method:"JSONP",cache:!0},query:{cache:!0,method:"GET",isArray:!0}})}}}]).filter("parseUrlFilter",function(){var urlPattern=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/gi,hashPattern=/(^|\s)#(\w*[a-zA-Z_]+\w*)/gim,mentionPattern=/(^|\s)\@(\w*[a-zA-Z_]+\w*)/gim;return function(text,target,service){var replacedText=text?text.replace(urlPattern,'<a target="'+target+'" href="$&">$&</a>'):text;return replacedText&&("twitter"===service?(replacedText=replacedText.replace(hashPattern,'$1<a class="hashtag" href="https://twitter.com/search?q=%23$2" target="'+target+'">#$2</a>'),replacedText=replacedText.replace(mentionPattern,'$1<a class="hashtag" href="https://twitter.com/$2" target="'+target+'">@$2</a>')):"instagram"===service?(replacedText=replacedText.replace(hashPattern,'$1<a class="hashtag" href="https://instagram.com/explore/tags/$2" target="'+target+'">#$2</a>'),replacedText=replacedText.replace(mentionPattern,'$1<a class="hashtag" href="https://instagram.com/$2" target="'+target+'">@$2</a>')):"facebook"===service&&(replacedText=replacedText.replace(hashPattern,'$1<a class="hashtag" href="https://facebook.com/hashtag/$2" target="'+target+'">#$2</a>'))),replacedText}}).controller("SocialController",["$scope","SocialFeed","$filter","$sce",function($scope,SocialFeed,$filter,$sce){$scope.inited=!1,$scope.services={facebook:{title:"Facebook",icon:"fa-facebook-square"},twitter:{title:"Twitter",icon:"fa-twitter-square"},youtube:{title:"Youtube",icon:"fa-youtube-play"},instagram:{title:"instagram",icon:"fa-instagram"}},$scope.activeServices="all";var citySocial="newyork_ny",settings=_.get($scope,"$parent.settings");_.has(settings,"agencies")&&settings.agencies.length&&(citySocial=settings.city+"_"+settings.state_short,citySocial=citySocial.toLowerCase().replace(" ",""));var userFeed=SocialFeed.getUser(citySocial),toSafeText=function(data){return _.map(data,function(item,key){data[key].body=$sce.trustAsHtml($filter("parseUrlFilter")(item.text,"_blank",item.service))}),data};$scope.switchService=function(service,event,limit,callback){event&&event.preventDefault();var isActive=$scope.isServiceActive(service),runQuery=!1,callback=callback||function(){};return $scope.inited&&!isActive&&($scope.activeServices=service,runQuery=!0),(runQuery||!$scope.inited)&&userFeed.query({"services[]":"all"==$scope.activeServices?[]:[$scope.activeServices],limit:limit||20},function(data){if(!$scope.inited){var active=[],services=_.clone($scope.services);_.map(data,function(item){active=_.union(active,[item.service])}),_.map(services,function(service,key){_.contains(active,key)&&(services[key].active=!0)}),$scope.services=services}toSafeText(data),$scope.social=$scope.preSort?_.chain(data).sortBy("date").reverse().value():data,$scope.inited=!0,callback()}),!1},$scope.isServiceActive=function(service){return $scope.activeServices==service},$scope.showServiceTab=function(service){return $scope.services[service].active},$scope.recent=function(){$scope.container.isotope({sortBy:"date"})},$scope.reFlow=function(){setTimeout(function(){$scope.$emit("iso-method",{name:"reLayout",params:null})},0)},$scope.shuffle=function(){$scope.$emit("iso-method",{name:"shuffle",params:null})},$scope.getPublishedDate=function(date){return new Date(date).getTime()},$scope.getPostUrl=function(item){switch(item.service){case"facebook":var url="http://facebook.com/"+item.account;return item.id?url+"/posts/"+item.id.substring(item.id.indexOf("_")+1):url;default:return item.url}}}]).directive("socialWall",function($window,$browser,$http,$timeout){return{restrict:"A",controller:"SocialController",templateUrl:"views/apps/socialApp/social.html",link:{pre:function($scope,$element,$attributes){$scope.socialPostCount=$scope.socialPostCount||20,$scope.socialShowControls=$scope.socialHideControls||!1,$scope.preSort=!0,$scope.inited||$scope.switchService(null,null,$scope.socialPostCount),$scope.container=$element.children("[isotope-container]")},post:function($scope,$element,$attributes){$scope.$watch("social",function(value){$scope.inited||$scope.container.isotope({getSortData:{date:function($elem){return $elem.data("date")}}}),$scope.social&&$timeout(function(){var imgLoad=$element.waitForImages();imgLoad.done(function(){$scope.container.isotope({sortBy:"date",sortAscending:!1})})},0)})}}}}).directive("socialTimeline",function($window,$browser,$http,$timeout){return{restrict:"A",controller:"SocialController",templateUrl:"views/apps/socialApp/social-timeline.html",compile:function(tElem,tAttrs){return{pre:function($scope,$element,$attributes){$scope.socialPostCount=$scope.socialPostCount||20,$scope.socialShowControls=$scope.socialHideControls||!1,$scope.preSort=!0,$scope.oddEvenSwitch=0,$scope.timelineSwitchService=function(service,event){$scope.switchService(service,event,$scope.socialPostCount,function(){$scope.oddEvenSwitch=$scope.oddEvenSwitch?0:1})},$scope.inited||$scope.switchService(null,null,$scope.socialPostCount)}}}}})}(jQuery);